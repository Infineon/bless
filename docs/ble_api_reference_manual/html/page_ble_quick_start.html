<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cypress PSoC 6 Bluetooth Low Energy Middleware Library 3.60: Quick Start Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="IFXCYP_one-line.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cypress PSoC 6 Bluetooth Low Energy Middleware Library 3.60</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_ble_quick_start.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Quick Start Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The PSoC 6 BLE Middleware can be used in various software environments such as ModusToolbox, etc.</p>
<p>Refer to <a class="el" href="page_ble_toolchain.html">Supported Software and Tools</a> page. The quickest way to get started is using the Code Examples. Cypress Semiconductor continuously extends its portfolio of code examples at the <a href="http://www.cypress.com/"><b>Cypress Semiconductor website</b></a> and at the <a href="https://github.com/cypresssemiconductor.com"><b>Cypress Semiconductor GitHub</b></a> site.</p>
<p>You must accomplish several tasks to implement a BLE standard profile application:</p><ul>
<li><a class="el" href="page_ble_quick_start.html#group_ble_quick_start1">PSoC 6 BLE Middleware configuration in BT Configurator</a></li>
<li><a class="el" href="page_ble_quick_start.html#group_ble_quick_start2">System and PSoC 6 BLE Middleware Initialization</a></li>
<li><a class="el" href="page_ble_quick_start.html#group_ble_quick_start3">Main Loop Implementation</a></li>
<li><a class="el" href="page_ble_quick_start.html#group_ble_quick_start4">Stack Event Handler</a></li>
<li><a class="el" href="page_ble_quick_start.html#group_ble_quick_start5">Service-specific Event Handler</a></li>
<li><a class="el" href="page_ble_quick_start.html#group_ble_quick_start6">Implement Low-power Performance</a></li>
</ul>
<p>The snippets below show an implementation of a simple Bluetooth SIG-defined standard profile called Find <a href="https://www.bluetooth.org/docman/handlers/downloaddoc.ashx?doc_id=239389">Me Profile (FMP)</a>. BLE midlleware is configured to operate in Complete BLE Protocol Single CPU mode. In this mode,the BLE functionality is entirely on the CM4 CPU core. It uses a software interface for communication between the controller and host. Refer to <a class="el" href="page_ble_section_configuration_considerations.html">Configuration Considerations</a> for details on how to configure the BLE middleware for operation in Complete BLE Protocol Dual CPU or Controller-only (HCI over Software API) modes.</p>
<h1><a class="anchor" id="group_ble_quick_start1"></a>
PSoC 6 BLE Middleware configuration in BT Configurator</h1>
<p> <style>div.image img[src="bt_config_general_tab.jpg"]{width:570px;}</style>   <style>div.image img[src="bt_config_gatt_tab.jpg"]{width:820px;}</style>   <style>div.image img[src="bt_config_gap_tab.jpg"]{width:820px;}</style>   <style>div.image img[src="bt_config_advervicement_packet.jpg"]{width:820px;}</style>   <style>div.image img[src="bt_config_advervicement_setting.jpg"]{width:820px;}</style>   <style>div.image img[src="bt_config_securiti_configuration.jpg"]{width:820px;}</style> </p>
<p>The <a href="https://www.cypress.com/ModusToolboxBLEConfig">ModusToolbox BT Configurator Guide</a> describes how to use BT Configurator. The BT Configurator Tool can be launched in ModusToolbox IDE from the BLE personality, as well as in stand-alone mode. Refer to <a href="https://www.cypress.com/products/modustoolbox-software-environment">ModusToolbox Software Environment, Quick Start Guide, Documentation, and Videos</a>.</p>
<p>For this Quick Start Guide, the PSoC 6 BLE Middleware is configured as the Find Me Target in the GAP Peripheral role with the settings shown in the figures below:</p>
<p><b>General Settings</b><br />
 Use the General tab for general configuration of the Bluetooth resource (e.g GAP role, max number of BLE connection, etc). </p><div class="image">
<img src="bt_config_general_tab.jpg" alt="bt_config_general_tab.jpg"/>
</div>
<p><b>GATT Settings</b><br />
 Use the GATT Settings tab to configure Profile-specific parameters. For this Quick Start Guide we add only Find Me profile (Find Me Target (GATT Server)). </p><div class="image">
<img src="bt_config_gatt_tab.jpg" alt="bt_config_gatt_tab.jpg"/>
</div>
<p><b>GAP Settings</b><br />
 Use the GAP Settings tab to configure GAP parameters, which define the general connection settings required when connecting Bluetooth devices. It contains various parameters based on the item you select in the tree.</p>
<p><em>General</em><br />
 In this panel you configure general GAP parameters (e.g. Public device address, Device Name, Appearance, Adv/Scan/Connections TX power level, etc). </p><div class="image">
<img src="bt_config_gap_tab.jpg" alt="bt_config_gap_tab.jpg"/>
</div>
<p><em>Advertisement Settings</em><br />
 In this panel you configure the general parameters for advertisement configuration (e.g. Discovery mode, Advertising type, Filter policy, Advertising Interval, etc). </p><div class="image">
<img src="bt_config_advervicement_setting.jpg" alt="bt_config_advervicement_setting.jpg"/>
</div>
<p><em>Advertisement Packet</em><br />
 In this panel you configure the Advertisement data to be used in device advertisements. </p><div class="image">
<img src="bt_config_advervicement_packet.jpg" alt="bt_config_advervicement_packet.jpg"/>
</div>
<p><em>Security Settings</em><br />
 In this panel you configure security settings for the device. The example uses a configuration that does not require authentication, encryption, or authorization for data exchange. </p><div class="image">
<img src="bt_config_securiti_configuration.jpg" alt="bt_config_securiti_configuration.jpg"/>
</div>
<p>PSoC 6 BLE Middleware configuration is saved in files "cycfg_ble.h" and "cycfg_ble.c". These files must be attached to the user project.</p>
<h1><a class="anchor" id="group_ble_quick_start2"></a>
System and PSoC 6 BLE Middleware Initialization</h1>
<p>When PSoC 6 BLE MCU is reset, the application should perform system initialization which includes: setting up the CPU cores for execution, enabling global interrupts, and enabling other components used in the design ( UART, MCWDT, etc). After the CPUs are initialized the application initializes the PSoC 6 BLE Middleware, which sets up a complete BLE subsystem.</p>
<p>As part of the PSoC 6 BLE Middleware initialization, you must:</p><ul>
<li>Initialize the BLESS interrupt. See <a class="el" href="page_ble_section_configuration_considerations.html#group_ble_section_conf_cons_intr">Configure BLESS Interrupt</a> for detailed information. The code below shows how to implement the routine (ISR) handler of the BLESS interrupt service (refer to BlessInterrupt() function). The <a class="el" href="group__group__ble__common__api__functions.html#gaf973ee7f4097d25ee569fd8bd3172265" title="Process interrupt events generated by the BLE sub-system. ">Cy_BLE_BlessIsrHandler()</a> function is called from BlessInterrupt() to process interrupt events generated by BLESS.</li>
<li>Register the generic event handler function to be called by the BLE stack to notify of pending events. Refer to <a class="el" href="group__group__ble__common__api__functions.html#ga3d3e2bf00cc87f8dfc17fa0c68fd7506" title="Registers a callback function to receive events from the PSoC 6 BLE Middleware. ">Cy_BLE_RegisterEventCallback()</a> function.</li>
<li>Call <a class="el" href="group__group__ble__common__api__functions.html#gac43daf6ecb84fde5390065532c7b7e69" title="Initializes the PSoC 6 BLE Middleware. ">Cy_BLE_Init()</a> to initialize PSoC 6 BLE Middleware. Pass the address of the configuration structure generated by the BT Configurator, cy_ble_config (exposed in cycfg_ble.c).</li>
<li>Call <a class="el" href="group__group__ble__common__api__functions.html#ga71930f6a2639719f896326a9bb73f543" title="Initializes and enable the BLE Stack. ">Cy_BLE_Enable()</a> to enable the BLE subsystem.</li>
<li>Register service-specific event handlers (the example uses only the IAS event handler to handle Immediate Alert Service related events). Refer to <a class="el" href="group__group__ble__service__api___i_a_s__server__client.html#ga5eaefdb8aace72fb807a01ae2dcffc50" title="Registers a callback function for service-specific attribute operations. ">Cy_BLE_IAS_RegisterAttrCallback()</a> function.</li>
</ul>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;cy_syslib.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;cy_sysint.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;cycfg.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;cycfg_ble.h&quot;</span></div><div class="line"> </div><div class="line"></div><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Global variables</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"><span class="comment">/* The Alert Level value */</span></div><div class="line"><span class="keyword">static</span> uint8_t                  alertLevel = <a class="code" href="group__group__ble__common__api__macros.html#ga3f7727fbf709001469a187eb1df36d34">CY_BLE_NO_ALERT</a>;</div><div class="line"> </div><div class="line"><span class="comment">/* The variables to initialize the BLE stack timer to get a 1-second interval */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="structcy__stc__ble__timer__info__t.html">cy_stc_ble_timer_info_t</a>  timerParam = { .<a class="code" href="structcy__stc__ble__timer__info__t.html#a7ad3d2bb388c7fb54c0bf6fdb50a2273">timeout</a> = 1u <span class="comment">/* second */</span> };</div><div class="line"><span class="keyword">static</span> uint8_t                  mainTimer = 1u;</div><div class="line"></div><div class="line"><span class="comment">/* LED8 and LED9 port definitions */</span></div><div class="line"><span class="preprocessor">#define LED8_PORT GPIO_PRT1</span></div><div class="line"><span class="preprocessor">#define LED8_PIN 5U</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define LED9_PORT GPIO_PRT13</span></div><div class="line"><span class="preprocessor">#define LED9_PIN 7U</span></div><div class="line"></div><div class="line"><span class="comment">/* BLESS interrupt configuration.</span></div><div class="line"><span class="comment"> * It is used when BLE middleware operates in BLE Single CM4 Core mode. */</span></div><div class="line"><span class="keyword">const</span> cy_stc_sysint_t blessIsrCfg =</div><div class="line">{</div><div class="line">    <span class="comment">/* The BLESS interrupt */</span></div><div class="line">    .intrSrc      = bless_interrupt_IRQn,</div><div class="line"> </div><div class="line">    <span class="comment">/* The interrupt priority number */</span></div><div class="line">    .intrPriority = 1u</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Private Function Prototypes</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> AppMainLoop(<span class="keywordtype">void</span>);</div><div class="line"><span class="keywordtype">void</span> AppCallBack(uint32_t event, <span class="keywordtype">void</span> *eventParam);</div><div class="line"><span class="keywordtype">void</span> IasEventHandler(uint32_t event, <span class="keywordtype">void</span> *eventParam);</div><div class="line"><span class="keywordtype">void</span> LowPowerImplementation(<span class="keywordtype">void</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Function Name: BlessInterrupt</span></div><div class="line"><span class="comment">********************************************************************************</span></div><div class="line"><span class="comment">* BLESS ISR</span></div><div class="line"><span class="comment">* It is used used when BLE middleware operates in BLE single CM4</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"><span class="comment">/* BLESS ISR */</span></div><div class="line"><span class="keywordtype">void</span> BlessInterrupt(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Call interrupt processing */</span></div><div class="line">    <a class="code" href="group__group__ble__common__api__functions.html#gaf973ee7f4097d25ee569fd8bd3172265">Cy_BLE_BlessIsrHandler</a>();</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Function Name: main()</span></div><div class="line"><span class="comment">********************************************************************************</span></div><div class="line"><span class="comment">* Summary:</span></div><div class="line"><span class="comment">*  Main function for the BLE project.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Enable interrupts */</span></div><div class="line">    __enable_irq();</div><div class="line">     </div><div class="line">    <span class="comment">/* Initialize all peripherals and system resources */</span></div><div class="line">    init_cycfg_all();</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize GPIO */</span>     </div><div class="line">    Cy_GPIO_Pin_FastInit(LED9_PORT, LED9_PIN, CY_GPIO_DM_STRONG_IN_OFF, 1u, HSIOM_SEL_GPIO);</div><div class="line">    Cy_GPIO_Pin_FastInit(LED8_PORT, LED8_PIN, CY_GPIO_DM_STRONG_IN_OFF, 1u, HSIOM_SEL_GPIO);</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the BLESS interrupt */</span></div><div class="line">    cy_ble_config.hw-&gt;blessIsrConfig = &amp;blessIsrCfg;</div><div class="line">    Cy_SysInt_Init(cy_ble_config.hw-&gt;blessIsrConfig, BlessInterrupt);</div><div class="line">     </div><div class="line">    <span class="comment">/* Register the generic event handler */</span></div><div class="line">    <a class="code" href="group__group__ble__common__api__functions.html#ga3d3e2bf00cc87f8dfc17fa0c68fd7506">Cy_BLE_RegisterEventCallback</a>(AppCallBack);</div><div class="line">     </div><div class="line">    <span class="comment">/* Initialize the BLE */</span></div><div class="line">    <a class="code" href="group__group__ble__common__api__functions.html#gac43daf6ecb84fde5390065532c7b7e69">Cy_BLE_Init</a>(&amp;cy_ble_config);</div><div class="line"> </div><div class="line">    <span class="comment">/* Enable BLE Low-power Mode (LPM) */</span></div><div class="line">    <a class="code" href="group__group__ble__common__api__functions.html#ga11dd55190fcf99efcc2dd0f625014f4b">Cy_BLE_EnableLowPowerMode</a>();</div><div class="line"> </div><div class="line">    <span class="comment">/* Enable BLE */</span></div><div class="line">    <a class="code" href="group__group__ble__common__api__functions.html#ga71930f6a2639719f896326a9bb73f543">Cy_BLE_Enable</a>();</div><div class="line"> </div><div class="line">    <span class="comment">/* Register the IAS CallBack */</span></div><div class="line">    <a class="code" href="group__group__ble__service__api___i_a_s__server__client.html#ga5eaefdb8aace72fb807a01ae2dcffc50">Cy_BLE_IAS_RegisterAttrCallback</a>(IasEventHandler);</div><div class="line"> </div><div class="line">    <span class="comment">/* Main loop implementation */</span></div><div class="line">    <span class="keywordflow">while</span>(1)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Main loop implementation */</span></div><div class="line">        AppMainLoop();</div><div class="line">    }    </div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="group_ble_quick_start3"></a>
Main Loop Implementation</h1>
<p>The main loop in the example has a simply flow:</p><ul>
<li>process the BLE stack pending events by a call to <a class="el" href="group__group__ble__common__api__functions.html#ga0f1982f915c28b0d5a317442bec9eafc" title="This function checks the internal task queue in the BLE Stack, and pending operation of the BLE Stack...">Cy_BLE_ProcessEvents()</a></li>
<li>process a received alert level: updates the LEDs based on the alert level</li>
<li>restarts the BLE stack timer to get a 1-second interval to blink the LED</li>
<li>the application goes into Low-power mode by call to the LowPowerImplementation() function.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> AppMainLoop(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Cy_BLE_ProcessEvents() allows the BLE stack to process pending events */</span> </div><div class="line">    <a class="code" href="group__group__ble__common__api__functions.html#ga0f1982f915c28b0d5a317442bec9eafc">Cy_BLE_ProcessEvents</a>();</div><div class="line">    </div><div class="line">    <span class="keywordflow">switch</span> (alertLevel)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__macros.html#ga3f7727fbf709001469a187eb1df36d34">CY_BLE_NO_ALERT</a> :</div><div class="line">        Cy_GPIO_Write(LED9_PORT, LED9_PIN, 1u); <span class="comment">/* LED_OFF */</span></div><div class="line">        break ;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__macros.html#gada3c7899e683c326e4ab13a09ca288fd">CY_BLE_MILD_ALERT</a> :</div><div class="line">        <span class="keywordflow">if</span>(mainTimer)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Toggle the alert LED after a timeout */</span> </div><div class="line">            Cy_GPIO_Inv(LED9_PORT, LED9_PIN);</div><div class="line">        }</div><div class="line">        break ;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__macros.html#ga58ceaf19cdb7e80cdd9b1b75ba512faa">CY_BLE_HIGH_ALERT</a> :</div><div class="line">        Cy_GPIO_Write(LED9_PORT, LED9_PIN, 0u); <span class="comment">/* LED_ON */</span></div><div class="line">        break ;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Restart the BLE stack timer. Used to get a 1-second interval to</span></div><div class="line"><span class="comment">        * blink the LED */</span></div><div class="line">    <span class="keywordflow">if</span>(mainTimer)</div><div class="line">    {</div><div class="line">        mainTimer = 0u;</div><div class="line">        <a class="code" href="group__group__ble__common__api__functions.html#gaf696cb866225d442f66baa0bcae397ef">Cy_BLE_StartTimer</a>(&amp;timerParam);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Enter deep-sleep to achieve low power in the device */</span> </div><div class="line">    LowPowerImplementation();</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="group_ble_quick_start4"></a>
Stack Event Handler</h1>
<p>The BLE stack within the PSoC 6 BLE Middleware generates events. These events provide status and data to the application firmware through the BLE stack event handler.</p>
<p>The event handler must handle a few basic events from the stack. For the Find Me Target application in this code example, the BLE stack event-handler must process the events described in table below. The actual code recognizes and responds to additional events.</p>
<table class="doxtable">
<tr>
<th align="left">BLE Stack Event Name </th><th align="left">Event Description </th><th align="left">Event Handler Action  </th></tr>
<tr>
<td align="left">CY_BLE_EVT_STACK_ON </td><td align="left">BLE stack initialization is completed successfully </td><td align="left">Start advertisement and reflect the advertisement state on the LED </td></tr>
<tr>
<td align="left">CY_BLE_EVT_GAP_DEVICE_DISCONNECTED </td><td align="left">BLE link with the peer device is disconnected </td><td align="left">Restart advertisement and reflect the advertisement state on the LED </td></tr>
<tr>
<td align="left">CY_BLE_EVT_GAP_DEVICE_CONNECTED </td><td align="left">BLE link with the peer device is established </td><td align="left">Update the BLE link state on the LED </td></tr>
<tr>
<td align="left">CY_BLE_EVT_GAPP_ADVERTISEMENT_START_STOP </td><td align="left">BLE stack advertisement start/stop event </td><td align="left">Shutdown the BLE stack </td></tr>
<tr>
<td align="left">CY_BLE_EVT_STACK_SHUTDOWN_COMPLETE </td><td align="left">BLE stack has been shutdown </td><td align="left">Put the device into Hibernate mode </td></tr>
<tr>
<td align="left">CY_BLE_EVT_GAP_AUTH_REQ </td><td align="left">BLE authentication request received </td><td align="left">Call <a class="el" href="group__group__ble__common__api__gap__peripheral__functions.html#gafd058b11ddcf322f0389c51917465334" title="This function is used by the GAP Peripheral application to send Pairing Response in authentication/pa...">Cy_BLE_GAPP_AuthReqReply()</a> to reply to the authentication request from Central </td></tr>
</table>
<p>The code snippets show examples of how the event handler responds to an identified events. See the actual source code for a complete understanding.</p>
<div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Function Name: AppCallBack</span></div><div class="line"><span class="comment">********************************************************************************</span></div><div class="line"><span class="comment">* Summary: This is an event callback function to receive events from the PSoC 6 BLE Middleware.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Parameters:</span></div><div class="line"><span class="comment">*   event      - The event code.</span></div><div class="line"><span class="comment">*   eventParam - The event parameters.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> AppCallBack(uint32_t event, <span class="keywordtype">void</span> *eventParam)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span>(event)</div><div class="line">    {</div><div class="line">      <span class="comment">/* Generic events (e.g CY_BLE_EVT_STACK_ON, CY_BLE_EVT_STACK_BUSY_STATUS, etc) */</span></div><div class="line">      . . .</div><div class="line">    </div><div class="line">      <span class="comment">/* GAP Events (e.g CY_BLE_EVT_GAP_AUTH_REQ, CY_BLE_EVT_GAP_AUTH_COMPLETE, CY_BLE_EVT_GAP_DEVICE_CONNECTED, etc) */</span></div><div class="line">       . . .</div><div class="line">     </div><div class="line">      <span class="comment">/* GATT Events (e.g CY_BLE_EVT_GATT_CONNECT_IND, CY_BLE_EVT_GATT_DISCONNECT_IND, etc) */</span></div><div class="line">       . . .</div><div class="line"></div><div class="line">      <span class="comment">/* Other Events */</span></div><div class="line">       . . .</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>In this snippet, the handler starts advertising in response to the CY_BLE_EVT_STACK_ON event. </p><div class="fragment"><div class="line">        <span class="comment">/* This event is received when the BLE stack is initialized and turned ON</span></div><div class="line"><span class="comment">         * by invoking the Cy_BLE_StackInit() function */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86a8934f1150b681fd0edbc395a27a9613d">CY_BLE_EVT_STACK_ON</a>:</div><div class="line">            <span class="comment">/* Enter into discoverable mode so that remote can find it */</span></div><div class="line">            <a class="code" href="group__group__ble__common__api__gap__peripheral__functions.html#gac26286c502401fc1bb3c9561b66733d7">Cy_BLE_GAPP_StartAdvertisement</a>(CY_BLE_ADVERTISING_FAST,</div><div class="line">                                           CY_BLE_PERIPHERAL_CONFIGURATION_0_INDEX);</div><div class="line">            <span class="keywordflow">break</span>;</div></div><!-- fragment --><p> In this snippet, the handler responds to the "advertisement start/stop" event. The code toggles the LEDs appropriately. If advertising has started, the advertisement LED turns on. The disconnect LED turns off, because the device started advertising and is ready for connection. If advertising stops, the code sets the LEDs appropriately, and sets a flag to enter Hibernate mode. </p><div class="fragment"><div class="line">        <span class="comment">/* This event indicates the peripheral device has started/stopped advertising */</span> </div><div class="line">        <span class="keywordflow">case</span>  <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86af7df7271c667f3dc2a99e492499134c6">CY_BLE_EVT_GAPP_ADVERTISEMENT_START_STOP</a>:</div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__group__ble__common__api__functions.html#ga4b070074c2af74238130830cfb570188">Cy_BLE_GetAdvertisementState</a>() == <a class="code" href="group__group__ble__common__api__gap__definitions.html#gga1af3aeb3bb744f0d9b7fe0b6859b8edcace0f9cadd252b1959497c6340b95385a">CY_BLE_ADV_STATE_STOPPED</a>)</div><div class="line">            {  </div><div class="line">                <span class="comment">/* The fast and slow advertising period is complete, go to Low-power </span></div><div class="line"><span class="comment">                * mode (Hibernate) and wait for an external user event to wake up </span></div><div class="line"><span class="comment">                * the device again */</span></div><div class="line">                <a class="code" href="group__group__ble__common__api__functions.html#gadb3de6a7f54f20646dcea989aad7e0f2">Cy_BLE_Disable</a>();</div><div class="line">                </div><div class="line">                Cy_GPIO_Write(LED8_PORT, LED8_PIN, 1u); <span class="comment">/* LED_OFF */</span></div><div class="line">                Cy_GPIO_Write(LED9_PORT, LED9_PIN, 1u); <span class="comment">/* LED_OFF */</span></div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;  </div></div><!-- fragment --><p> In this snippet, the handler responds to the "disconnected" event. It starts advertising and sets the LEDs correctly. </p><div class="fragment"><div class="line">        <span class="comment">/* This event is generated when disconnected from a remote device or failed </span></div><div class="line"><span class="comment">         * to establish connection */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86af76865d155be4ef9a842e5fe30eec6d5">CY_BLE_EVT_GAP_DEVICE_DISCONNECTED</a>:</div><div class="line">            <span class="comment">/* Start BLE advertising for 30 seconds and update the link status on the LEDs */</span></div><div class="line">            <a class="code" href="group__group__ble__common__api__gap__peripheral__functions.html#gac26286c502401fc1bb3c9561b66733d7">Cy_BLE_GAPP_StartAdvertisement</a>(CY_BLE_ADVERTISING_FAST,</div><div class="line">                                           CY_BLE_PERIPHERAL_CONFIGURATION_0_INDEX);</div><div class="line">    </div><div class="line">            <span class="comment">/* Set default value for alert level (CY_BLE_NO_ALERT) */</span></div><div class="line">            alertLevel = <a class="code" href="group__group__ble__common__api__macros.html#ga3f7727fbf709001469a187eb1df36d34">CY_BLE_NO_ALERT</a>;</div><div class="line">    </div><div class="line">            Cy_GPIO_Write(LED8_PORT, LED8_PIN, 0u); <span class="comment">/* LED_ON */</span></div><div class="line">            Cy_GPIO_Write(LED9_PORT, LED9_PIN, 1u); <span class="comment">/* LED_OFF */</span></div><div class="line">            <span class="keywordflow">break</span>;</div></div><!-- fragment --><p> In this snippet, the handler receives a timeout from BLE stack timer. In this example the BLE stack timer is used to get a 1-second interval to blink the LED. </p><div class="fragment"><div class="line">        <span class="comment">/* This event is received when there is a timeout and the application</span></div><div class="line"><span class="comment">         * must handle the event */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86a5faab937dcd719a5cc5cb8e8b749dcaa">CY_BLE_EVT_TIMEOUT</a>:</div><div class="line">            <span class="keywordflow">if</span>( (((<a class="code" href="structcy__stc__ble__timeout__param__t.html">cy_stc_ble_timeout_param_t</a> *)eventParam)-&gt;reasonCode == </div><div class="line">                    <a class="code" href="group__group__ble__common__api__definitions.html#gga9401245e7b20db19f6b735d6295a6113a337fd92ce11151df7eaab75a89fe9694">CY_BLE_GENERIC_APP_TO</a>) &amp;&amp;</div><div class="line">                (((<a class="code" href="structcy__stc__ble__timeout__param__t.html">cy_stc_ble_timeout_param_t</a> *)eventParam)-&gt;timerHandle == </div><div class="line">                    timerParam.<a class="code" href="structcy__stc__ble__timer__info__t.html#a0f48deb9ffee581143a5c57c2beb3722">timerHandle</a>) )</div><div class="line">            {</div><div class="line">                <span class="comment">/* Indicate that the timer is raised to the main loop */</span></div><div class="line">                mainTimer++;</div><div class="line">                    </div><div class="line">                <span class="comment">/* Update the LED state */</span></div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__group__ble__common__api__functions.html#ga4b070074c2af74238130830cfb570188">Cy_BLE_GetAdvertisementState</a>() == <a class="code" href="group__group__ble__common__api__gap__definitions.html#gga1af3aeb3bb744f0d9b7fe0b6859b8edcaa52f2e981fb0e7902fe2dea2df3e0510">CY_BLE_ADV_STATE_ADVERTISING</a>)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Advertising state */</span></div><div class="line">                    Cy_GPIO_Inv(LED8_PORT, LED8_PIN);</div><div class="line">                    Cy_GPIO_Write(LED9_PORT, LED9_PIN, 1u); <span class="comment">/* LED_OFF */</span></div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="group__group__ble__common__api__functions.html#ga20cdd5796acf84dcea347f3c40274352">Cy_BLE_GetNumOfActiveConn</a>() == 0u)</div><div class="line">                {</div><div class="line">                    <span class="comment">/* Disconnected state */</span></div><div class="line">                    Cy_GPIO_Write(LED8_PORT, LED8_PIN, 0u); <span class="comment">/* LED_ON */</span></div><div class="line">                    Cy_GPIO_Write(LED9_PORT, LED9_PIN, 1u); <span class="comment">/* LED_OFF */</span></div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    <span class="comment">/* Connected state: update the alert level value LED8 */</span></div><div class="line">                Cy_GPIO_Write(LED8_PORT, LED8_PIN, 1u); <span class="comment">/* LED_OFF */</span></div><div class="line">                }  </div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div></div><!-- fragment --><p> In this snippet, the handler puts the device into Hibernate mode in response to the CY_BLE_EVT_STACK_SHUTDOWN_COMPLETE event. </p><div class="fragment"><div class="line">        <span class="comment">/* This event is used to inform the application that BLE Stack shutdown</span></div><div class="line"><span class="comment">         * is complete */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86a19cedb90d0f015c6656b1228cdd67931">CY_BLE_EVT_STACK_SHUTDOWN_COMPLETE</a>:</div><div class="line">            <span class="comment">/* Set the device into Hibernate mode */</span></div><div class="line">            Cy_SysPm_SystemEnterHibernate();</div><div class="line">            <span class="keywordflow">break</span>;</div></div><!-- fragment --><p> In this snippet, the handler responds to the authentication request from the Central device. The peripheral device must call <a class="el" href="group__group__ble__common__api__gap__peripheral__functions.html#gafd058b11ddcf322f0389c51917465334" title="This function is used by the GAP Peripheral application to send Pairing Response in authentication/pa...">Cy_BLE_GAPP_AuthReqReply()</a> to reply to the authentication request from the Central. </p><div class="fragment"><div class="line">        <span class="comment">/* This event can be received by a device in Peripheral or Central role. </span></div><div class="line"><span class="comment">         * When it is received by a device in a Peripheral role, it must call </span></div><div class="line"><span class="comment">         * Cy_BLE_GAPP_AuthReqReply() to reply to the authentication request from Central */</span></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__group__ble__common__api__events.html#gga7c1ef7e6d246e0f3eb6c883e23d82b86a308f9ebe8fdaa68ee1cbec7af7f5b731">CY_BLE_EVT_GAP_AUTH_REQ</a>:</div><div class="line">            <span class="keywordflow">if</span>(cy_ble_config.authInfo[CY_BLE_SECURITY_CONFIGURATION_0_INDEX].security ==</div><div class="line">                (CY_BLE_GAP_SEC_MODE_1 | <a class="code" href="group__group__ble__common__api__gap__definitions.html#ggafb9216cdc0f9e4c7b84ef3ac7b3dbc94aa13a718ebe8472f4e9625d508a9fed46">CY_BLE_GAP_SEC_LEVEL_1</a>))</div><div class="line">            {</div><div class="line">                cy_ble_config.authInfo[CY_BLE_SECURITY_CONFIGURATION_0_INDEX].authErr =</div><div class="line">                    <a class="code" href="group__group__ble__common__api__gap__definitions.html#gga8111b4f1559c12cc45f0f9babb16f823a8fa09a4257c09e58cfefb9fa1e04569b">CY_BLE_GAP_AUTH_ERROR_PAIRING_NOT_SUPPORTED</a>;</div><div class="line">            }   </div><div class="line">        </div><div class="line">            cy_ble_config.authInfo[CY_BLE_SECURITY_CONFIGURATION_0_INDEX].bdHandle =</div><div class="line">                ((<a class="code" href="structcy__stc__ble__gap__auth__info__t.html">cy_stc_ble_gap_auth_info_t</a> *)eventParam)-&gt;bdHandle;</div><div class="line">        </div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__group__ble__common__api__gap__peripheral__functions.html#gafd058b11ddcf322f0389c51917465334">Cy_BLE_GAPP_AuthReqReply</a>(&amp;cy_ble_config.authInfo[CY_BLE_SECURITY_CONFIGURATION_0_INDEX]) !=</div><div class="line">                    <a class="code" href="group__group__ble__common__api__definitions.html#gga63f6be7f53f5ad7d82c394e4cdfa619ea26e476ee364252903ce212deeb6ec064">CY_BLE_SUCCESS</a>)           </div><div class="line">            {</div><div class="line">                <a class="code" href="group__group__ble__common__api__gap__functions.html#ga8dd8f2851594f8512b09819e13bd1d7c">Cy_BLE_GAP_RemoveOldestDeviceFromBondedList</a>();</div><div class="line">                <a class="code" href="group__group__ble__common__api__gap__peripheral__functions.html#gafd058b11ddcf322f0389c51917465334">Cy_BLE_GAPP_AuthReqReply</a>(&amp;cy_ble_config.authInfo[CY_BLE_SECURITY_CONFIGURATION_0_INDEX]);           </div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div></div><!-- fragment --><h1><a class="anchor" id="group_ble_quick_start5"></a>
Service-specific Event Handler</h1>
<p>The PSoC 6 BLE Middleware also generates events corresponding to each of the services supported by the design. For the Find Me Target application, the PSoC 6 BLE Middleware generates IAS events that let the application know that the Alert Level characteristic has been updated with a new value. The event handler gets the new value and stores it in the variable alertLevel. The main loop toggles the alert LED based on the current alert level.</p>
<p>The code snippet shows how the firmware accomplishes this task. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> IasEventHandler(uint32_t event, <span class="keywordtype">void</span> *eventParam)</div><div class="line">{</div><div class="line">    <span class="comment">/* Alert Level Characteristic write event */</span></div><div class="line">    <span class="keywordflow">if</span>(event == <a class="code" href="group__group__ble__service__api__events.html#ggada4b6b6d080ad4380e3a2e3cab4f2d51a892e3adb2589cde7257346928e97ee59">CY_BLE_EVT_IASS_WRITE_CHAR_CMD</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Read the updated Alert Level value from the GATT database */</span></div><div class="line">        <a class="code" href="group__group__ble__service__api___i_a_s__server.html#ga1898e12f1c143f416553829d42b04089">Cy_BLE_IASS_GetCharacteristicValue</a>(<a class="code" href="group__group__ble__service__api___i_a_s__definitions.html#ggad27f470965bbd7e1938ef52ec411d11fa0e8d27cc4a06ffa0a7f27cea77a0aa1f">CY_BLE_IAS_ALERT_LEVEL</a>, </div><div class="line">                                           <span class="keyword">sizeof</span>(alertLevel), </div><div class="line">                                           &amp;alertLevel);</div><div class="line">    }</div><div class="line">    </div><div class="line">    (void) eventParam;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="group_ble_quick_start6"></a>
Implement Low-power Performance</h1>
<p>In the application process, the CPU processes the pending BLE events. If there are no events pending, the CPU enters the deep sleep power mode. </p><div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Function Name: LowPowerImplementation</span></div><div class="line"><span class="comment">********************************************************************************</span></div><div class="line"><span class="comment">* Summary: Implements low power in the project.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Theory:</span></div><div class="line"><span class="comment">*  The function tries to enter CPU deep sleep as much as possible - whenever the</span></div><div class="line"><span class="comment">*  BLE is idle.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"><span class="keywordtype">void</span> LowPowerImplementation(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Entering Deep Sleep */</span></div><div class="line">    Cy_SysPm_DeepSleep(CY_SYSPM_WAIT_FOR_INTERRUPT);</div><div class="line">}</div></div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Cypress PSoC 6 Bluetooth Low Energy Middleware Library 3.60</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
